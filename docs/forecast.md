# Прогнозирование

Использование стратегий управления запасами, таких как метод фиксированного размера заказа и метод фиксированного периода заказа, для распределения товаров по региональным складам на маркетплейсах имеет несколько значительных преимуществ:

**Оптимизация запасов**

Эти стратегии помогают оптимизировать уровень запасов на региональных складах. Метод фиксированного размера заказа исходит из расчетов, направленных на минимизацию затрат на хранение и заказ товаров, что позволяет поддерживать минимально необходимые запасы и избегать избыточных.

**Снижение затрат**

Оба метода позволяют снизить общие затраты на управление запасами. Метод фиксированного размера заказа помогает минимизировать затраты на заказы, а метод фиксированного периода заказа упрощает процесс управления запасами, что снижает операционные расходы.

**Улучшение уровня обслуживания клиентов**

Правильное управление запасами с использованием этих стратегий обеспечивает более надежное и быстрое обслуживание клиентов. Товары всегда доступны на складе в соответствии с планом заказов, что удовлетворяет потребности клиентов и способствует удержанию клиентской базы.

**Более точное прогнозирование спроса**

Эти стратегии требуют анализа и учета спроса на товары. Это способствует более точному прогнозированию спроса и позволяет быстро реагировать на изменения в рыночных условиях.

**Улучшение управления рисками**

Правильное управление запасами помогает снизить риски, связанные с недостаточными запасами или избыточными запасами товаров. Это способствует более стабильной и надежной работе бизнеса.

**Простота внедрения и масштабирования**

Оба метода относительно просты в реализации и могут быть легко адаптированы к различным бизнес-моделям и объемам. Они также могут масштабироваться по мере роста бизнеса.

## Методы прогнозирования:

Одним из ключевых факторов для оптимизации является максимальное приближение товаров к покупателю. Озон внедряет инновационный подход к расчету стоимости услуги "Логистика" на схеме FBO (Fulfillment by Ozon), который учитывает уровень локализации товаров. Индекс локализации учитывает продажи как на FBO, так и на FBS (Fulfillment by Seller), и на его основе рассчитывается стоимость логистики для отправлений FBO. Вот как это работает:

При индексе локализации от 70% и выше, предоставляется скидка на логистику до 50%. Это существенное снижение затрат для продавцов и более выгодные условия для покупателей.

При индексе локализации от 55% до 70%, стоимость логистики рассчитывается по обычному тарифу, обеспечивая справедливость для всех продавцов и уровень сервиса для покупателей.

При индексе локализации ниже 55%, действует повышенный тариф, при котором начисляется до 30% к стоимости логистики. Этот подход стимулирует продавцов распределять товары более равномерно и учитывать спрос в различных регионах.
Дополнительным бонусом является то, что товары, которые находятся на ближайшем к пользователю складе FBO, получают +5% к релевантности при формировании поисковой выдаче покупателю, что положительно сказывается на продажах.

Прогнозирование поставок - это важная часть процесса распределения товаров по региональным складам на маркетплейсах. Этот раздел описывает две основные стратегии управления запасами, которые ваша библиотека поддерживает: метод фиксированного размера заказа и метод фиксированного периода заказа.

С помощью данной библиотеки пользователи могут сформировать план для распределения товаров по региональным складам.

### Метод 1: алгоритм на основе метода фиксированного размера заказа

Метод фиксированного размера заказа (FOS – Fixed Order Size) является одной из наиболее распространенных стратегий управления запасами. Этот метод основан на поддержании оптимального уровня запасов, который минимизирует общие затраты на хранение и заказ товаров, при этом не допуская out-of-stock. 

#### Принцип работы

##### Определение параметров

Для каждого товара необходимо ввести следующие параметры:
- Статистика продаж ([пример получения данных](https://github.com/strite-ru/strite-data-hub/blob/master/examples/ozon_get_all_posting.py))
- Время доставки и сборки партии(от пользователя)
- Оптимальный размер заказа(от пользователя)

##### Расчет параметров стратегии(FOS)

Используя формулу EOQ, определяется оптимальное количество товара, которое следует заказывать в каждом заказе. Формула EOQ выглядит следующим образом:
$$ Q_{c} =  x_{p}  \sqrt{( t_{c} +  \frac{ \Delta }{2}) *  \sigma^{2}_{D} +  D^{2} * \sigma^{2}_{t}  } $$
Где:
- $x_{p}$ - значение коэффициента интеграла потерь для уровня надёжности P = 95%;
- $t_{c}$ - время выполнения заказа, дн.; 
- $\Delta$ - интервал времени контроля запаса, дн.;
- $\sigma_{D}$ - среднее квадратическое отклонение среднесуточного расхода продукции; 
- $_{D}$ - среднесуточное потребление, шт.; 
- $\sigma_{t}$ - среднее квадратическое отклонение времени выполнения заказа

##### Расчет точки заказа (ROP)

Определяется уровень запаса, при достижении которого необходимо оформить заказ на дополнительные товары. Формула ROP может быть определена следующим образом:
$$ Q_{з} = \overline{D} * \tau + Q_{c} $$
Где:
- $\overline{D}$ - среднее потребление, шт.;
- $\tau$ - время доставки и сборки партии, дн.;
- $Q_{c}$ - оптимальный размер заказа, шт.

##### Расчет страхового запаса (SS)

Определяется минимальный запас, который необходимо поддерживать на складе для предотвращения out-of-stock. Формула SS может быть определена следующим образом:
$$ SS = x_{p} * \sqrt{( t_{c} +  \frac{ \Delta }{2}) *  \sigma^{2}_{D} +  D^{2} * \sigma^{2}_{t}  } $$
Где:
- $x_{p}$ - значение коэффициента интеграла потерь для уровня надёжности P = 95%;
- $t_{c}$ - время выполнения заказа, дн.;
- $\Delta$ - интервал времени контроля запаса, дн.;
- $\sigma_{D}$ - среднее квадратическое отклонение среднесуточного расхода продукции;
- $_{D}$ - среднесуточное потребление, шт.;
- $\sigma_{t}$ - среднее квадратическое отклонение времени выполнения заказа.

В результате рассчитываются следующие параметры:
- страховой запас
- максимальный запас
- точка заказа 
- дата поставки 
- средний уровень запаса остатков на складе.

[Полный пример кода](https://github.com/strite-ru/supply-demo)

### Метод 2: алгоритм на основе метода фиксированного периода заказа

Метод фиксированного периода заказа - это стратегия, при которой заказы на товары делаются с определенной периодичностью, независимо от уровня запасов. Этот метод позволяет упростить процесс управления запасами, но может привести к более высоким затратам на хранение.

#### Принцип работы

##### Определение параметров

Для каждого товара необходимо определить следующие параметры:
- Статистика продаж ([пример получения данных](https://github.com/strite-ru/strite-data-hub/blob/master/examples/ozon_get_all_posting.py))
- Оптимальный размер заказа(получаем от пользователя)
- Период поставки(получаем от пользователя)

##### Расчет размера заказа

Определяется оптимальный размер заказа, который необходимо сделать в следующий раз. Формула для расчета размера заказа может быть определена следующим образом:
$$ Q_{c} = x_{p} * \sigma_{D} \sqrt{t_{c} + t_{з}} $$
Где:
- $x_{p}$ - значение коэффициента интеграла потерь для уровня надёжности P = 95%;
- $t_{c}$ - время выполнения заказа, дн.;
- $t_{з}$ - период поставки, дн.;
- $\sigma_{D}$ - среднее квадратическое отклонение среднесуточного расхода продукции.

##### Расчет точки заказа (ROP)

Определяется уровень запаса, при достижении которого необходимо оформить заказ на дополнительные товары. Формула ROP может быть определена следующим образом:
$$ Q_{з} = \overline{D} * \tau + Q_{c} $$
Где:
- $\overline{D}$ - среднее потребление, шт.;
- $\tau$ - время доставки и сборки партии, дн.;
- $Q_{c}$ - оптимальный размер заказа, шт.

##### Расчет страхового запаса (SS)

Определяется минимальный запас, который необходимо поддерживать на складе для предотвращения out-of-stock. Формула SS может быть определена следующим образом:

$$ SS = x_{p} * \sigma_{D} \sqrt{t_{c} + t_{з}} $$
Где:
- $x_{p}$ - значение коэффициента интеграла потерь для уровня надёжности P = 95%;
- $t_{c}$ - время выполнения заказа, дн.;
- $t_{з}$ - период поставки, дн.;
- $\sigma_{D}$ - среднее квадратическое отклонение среднесуточного расхода продукции.

##### Расчет максимального запаса

Определяется максимальный запас, который может быть на складе. Формула для расчета максимального запаса может быть определена следующим образом:

$$ Q_{max} = Q_{c} + \overline{D} * t_{з} $$
Где:
- $Q_{c}$ - оптимальный размер заказа, шт.;
- $\overline{D}$ - среднее потребление, шт.;
- $t_{з}$ - период поставки, дн.

В результате рассчитываются следующие параметры:
- страховой запас 
- максимальный запас 
- размер поставки 
- дата следующей поставки 
- средний уровень запаса.

[Пример кода](https://github.com/strite-ru/supply-demo)

#### Сравнение методов

Оба метода имеют свои преимущества и ограничения. Метод фиксированного размера заказа обычно более эффективен с точки зрения минимизации затрат, но требует более аккуратного мониторинга запасов и расчетов. Метод фиксированного периода заказа более прост в управлении, но может привести к избыточным запасам.


### Метод 3: алгоритм на основе нейронной сети CatBoostRegressor

Модель обучается на данных о продажах товаров на маркетплейсе. Для обучения модели необходимо предоставить данные о продажах за последние 6 - 12 месяцев. Модель обучается на данных о продажах за последние 3 месяца и предсказывает продажи на 7 дней вперед.

#### Входные данные для CatBoost:

- цена продажи
- количество продаж
- месяц (1-12)
- день недели (0-6)
- продажи за вчерашний день
- продажи за последние 3 дня
- продажи за последние 7 дней

#### Выходные данные:

- количество продаж

В данной работе использовалось 3 метода машинного обучения – CatBoost, XGBoost и LSTM-нейронная сеть. Все эти модели являются достаточно сложными и имеют множество параметров. Поэтому для того, чтобы их применение было оправданным, они должны превзойти более простые способы предсказаний. Одним из наиболее простых способов предсказания является скользящее среднее (simple moving average).

Основная модель CatBoost – одну из глубоких модификаций алгоритма случайного леса. Несмотря на то, что эта модель по своим результатам в итоге уступила XGBoost (таблица ниже), она является более широко применимой в контексте поставленной задачи. Это так, потому что из всех построенных моделей только CatBoost может полноценно работать с пропущенными значениями. 

| Метрика    | Simple MA | XGBoost | LSTM   | CatBoost |
|------------|-----------|---------|--------|----------|
| RMSE       | 73.222    | 44.674  | 69.669 | 55.895   |
| MAE        | 29.382    | 14.869  | 27.247 | 16.598   |
| Median AE  | 11.0      | 4.194   | 9.472  | 5.164    |
| Median APE | 39.535    | 18.64   | 34.054 | 24.324   |


Сделав более точный прогноз вы более точно формируете будущую поставку и снижаете затраты на хранение и логистику.

#### Оценка точности модели на реальных данных разных объемов

Модель дает наиболее точные предсказания если предоставить ей данные более чем 8000 заказов.

| Объем данных | Точность предсказания |
|:------------:|:---------------------:|
|     1000     |          0%           |
|     2000     |          33%          |
|     3000     |          40%          |
|     4000     |          29%          |
|     5000     |          44%          |
|     6000     |          44%          |
|     7000     |          40%          |
|     8000     |          75%          |


Ошибка прогнозирования – 25%, поэтому мы рекомендуем формировать поставку с учетом страхового запаса, составляющего 20% от прогнозного значения.

#### Пример использования:

```python
import pickle
from rich.console import Console
from rich.table import Table
from strite_data_hub.prediction.supplies.catboost import train_model_by_ozon_postings


def main():
    # Как получить все товары и отправления с ozon см. в examples/ozon_get_all_posting.py и examples/ozon_get_product.py
    with open('all_products.pickle', 'rb') as f:
        products = pickle.load(f)

    with open('all_postings.pickle', 'rb') as f:
        postings = pickle.load(f)

    print(f"Всего отправлений: {len(postings)}")
    print(f"Всего товаров: {len(products)}")

    model, test_predicts = train_model_by_ozon_postings(products, postings)

    console = Console()

    table = Table(title="Предсказание продаж на 7 дней")
    table.add_column("Артикул", justify="left", style="cyan", no_wrap=True)
    table.add_column("Предсказание", justify="center", style="cyan", no_wrap=True)
    table.add_column("Фактически", justify="center", style="cyan", no_wrap=True)

    for row in test_predicts:
        table.add_row(
            row['vendor_code'],
            str(round(row['predict'])),
            str(row['actual'])
        )

    console.print(table)


if __name__ == '__main__':
    main()
```
[Пример кода](https://github.com/strite-ru/strite-data-hub/blob/master/examples/ozon_train_ml.py)